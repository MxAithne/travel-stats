<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MxAithne's Travel Stats</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
    <script>
    	console.log("Starting");
    	d3.csv("./travel-data.csv", function(data)
    	{
    		// A dictionary of all the stations, index by their station codes
    		var stationDictionary = {};

    		// Make a list of all the codes that represent either an origin or destination
    		var usedcodes = [];
    		for (var i in data)
    		{
    			if (usedcodes.indexOf(data[i].Origin) == -1) { usedcodes.push(data[i].Origin); }
    			if (usedcodes.indexOf(data[i].Destination) == -1) { usedcodes.push(data[i].Destination); }
    		}

    		// Make station objects for each code
    		for (var i in usedcodes)
    		{
    			stationDictionary[usedcodes[i]] = ({"code": usedcodes[i], "origin": 0, "dest": 0});
    		}

    		console.log(data[0]);
    		var origincnt = d3.nest()
    			.key(function(d) {return d.Origin; })
    			.rollup(function(v) {return v.length; })
    			.entries(data)
    			.forEach(function(m) { stationDictionary[m.key].origin = m.values; });
    		var destcnt = d3.nest()
    			.key(function(d) {return d.Destination; })
    			.rollup(function(v) {return v.length; })
    			.entries(data)
    			.forEach(function(m) { stationDictionary[m.key].dest = m.values; });

    		// Make a list of all the stations
    		var stations = [];
    		for (var i in stationDictionary)
    		{
    			stations.push(stationDictionary[i]);
    		}

    		// Figure out the total times a station has been used as an origin or destination
    		for (var i in stations) 
    		{
    			stations[i].totjourney = stations[i].origin + stations[i].dest;
    		}

    		stations.sort(function (a, b) { return b.totjourney - a.totjourney; });

    		console.log(stations);

		    var width = 500;
    		var barHeight = 10;
    		var xoffset = 100;

    		var x = d3.scale.linear()
    			.range([0, width - (xoffset + 10) ]);

				var chart = d3.select("#travel-graph")
    			.attr("width", width);

 				// Set the scale for the x-axis so it goes from 0 to the biggest value
  			x.domain([0, d3.max(stations, function(station) { 
  				return Math.max(station.origin, station.dest); 
  			})]); 

  			// Set the height of the whole graph
  			chart.attr("height", barHeight * 2.5 * stations.length);

  			// Make a "g" SVG element for each station (this means "group" of items in SVG)
  			var bar = chart.selectAll("g")
      		.data(stations)
    			.enter().append("g")
      		.attr("transform", function(station, i) { return "translate(0," + (i * barHeight * 2.5) + ")"; });

      	

  			// Make "lines" SVG elements for arrivals and departures
  			bar.append("line")
  				.attr("x1", xoffset)
  				.attr("y1", barHeight * 0.5)
      		.attr("x2", function(station) { 
      			return xoffset + x(station.origin);
      		})
      		.attr("y2", barHeight * 0.5)
      		.attr("class", "origin");
  			bar.append("line")
  				.attr("x1", xoffset)
  				.attr("y1", barHeight * 1.5)
      		.attr("x2", function(station) { 
      			return xoffset + x(station.dest);
      		})
      		.attr("y2", barHeight * 1.5)
      		.attr("class", "dest");

  			// Put some text next to the lines
				bar.append("text")
      		.attr("x", xoffset - 10)
      		.attr("y", barHeight * 1)
      		.attr("dy", ".35em")
      		.attr("class", "stationCode")
      		.text(function(station) { return station.code; });

  			bar.append("text")
      		.attr("x", function(station) { return xoffset + x(station.origin) + 5; })
      		.attr("y", barHeight * 0.5)
      		.attr("dy", ".35em")
      		.text(function(station) { return station.origin; });

      	bar.append("text")
      		.attr("x", function(station) { return xoffset + x(station.dest) + 5; })
      		.attr("y", barHeight * 1.5)
      		.attr("dy", ".35em")
      		.text(function(station) { return station.dest; });
			});
    </script>
  </head>

  <body>
    <header><h1>MxAithne's Travel Stats</h1></header>
    <content>
    	<svg id="travel-graph"></svg>
    </content>
  </body>
</html>